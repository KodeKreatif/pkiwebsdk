<script src="bundle.js"></script>
<script>
  console.log(PKIWebSDK);
  if (!window.File && !window.FileReader && !window.FileList && !window.Blob) {
    alert('The File APIs are not fully supported in this browser.');
  }

  var data;
  var files = [];
  var sign = function(){
    var pem = document.getElementById("existingPrivateKey").value;
    PKIWebSDK.Key.parsePEM(pem, "SHA-256")
      .then(function(parsedPEM){
        console.log("parsedPEM");
        console.log(parsedPEM);
        parsedPEM.sign(data)
          .then(function(signature){
            toFile(signature); 
          })
          .catch(function(err){
            alert(err);
          })
      })
      .catch(function(err){
        alert(err);
      })
  }
  var generateAndSign = function() {
    if (files.length < 1) {
      return alert("No file selected");
    }
    PKIWebSDK.Key.generatePair("SHA-256")
      .then(function(keyPair){
        console.log(keyPair);
        keyPair.privateKey.toPEM()
          .then(function(pemString){
            console.log(pemString);
            var privateKeyContainer = document.getElementById("privateKeyContainer");
            privateKeyContainer.innerHTML = pemString;
          })
          .catch(function(err){
            alert(err);
          })
        keyPair.publicKey.toPEM()
          .then(function(pemString){
            console.log(pemString);
            var publicKeyContainer = document.getElementById("publicKeyContainer");
            publicKeyContainer.innerHTML = pemString;

          })
          .catch(function(err){
            alert(err);
          })
        // privateKey has been generated. Now, sign the data
        console.log(typeof data);
        keyPair.privateKey.sign(data)
          .then(function(signature){
            toFile(signature); 
        })
        .catch(function(err){
          alert(err);
        })
      })
      .catch(function(err){
        alert(err);
      });
  }
  var toFile = function(arrayBuffer){
    // downloading!
    var blob = new Blob([arrayBuffer], { type: "text/plain" });
    var filename = "signature";
    if (typeof window.navigator.msSaveBlob !== 'undefined') {
      window.navigator.msSaveBlob(blob, filename);
    } else {
      var URL = window.URL || window.webkitURL;
      var downloadUrl = URL.createObjectURL(blob);
      if (filename) {
        var a = document.createElement("a");
        if (typeof a.download === 'undefined') {
          window.location = downloadUrl;
        } else {
          a.href = downloadUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
        }
      } else {
        window.location = downloadUrl;
      }
      setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100);
    }
  }
  setTimeout(function(){
    document.getElementById('files').addEventListener('change', function(evt){
      console.log("file added");
      files = evt.target.files; // FileList object  
      // files is a FileList of File objects. List some properties.
      // Read file as ArrayBuffer
      console.log(files[0]);
      var reader = new window.FileReader()
      reader.readAsArrayBuffer(files[0]);
      reader.onload = function(e) {
        data = reader.result;
        console.log(data)
       }
  
    });
  }, 500) 
</script>

<div>
  <input type="file" id="files" name="files[]" multiple />
  <hr>
  <h4>Sign with existing key</h4>
  <textarea cols="80" rows="40" style="margin:10px;" id="existingPrivateKey"></textarea>
  <br>
  <button onClick="sign()">Sign this file with existing private key</button>
</div>
