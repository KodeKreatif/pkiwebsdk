<script src="../../build/bundle.js"></script>
<script>
var data;
var files = [];
var certificate;
var record = {
  issuer : {
    commonName : "example.org",
    countryName : "US",
    stateName : "Virgina",
    localityName : "Blackburg",
    organizationName : "Test",
    organizationUnit : "Test"
  },
  subject : {
    commonName : "example.org",
    countryName : "US",
    stateName : "Virgina",
    localityName : "Blackburg",
    organizationName : "Test",
    organizationUnit : "Test"
  }
}
var subject = {
    commonName : "example.org",
    countryName : "US",
    stateName : "Virgina",
    localityName : "Blackburg",
    organizationName : "Test",
    organizationUnit : "Test"
}

var k = {}

// convert string to ArrayBuffer
var string2Ab = function(str, cb) {
  var buf = new ArrayBuffer(str.length*2);
  var bufView = new Uint16Array(buf);
  for (var i=0, strLen=str.length; i<strLen; i++) {
    bufView[i] = str.charCodeAt(i);
  }
  return cb(buf);
}

// convert base64 string to array buffer
var base642Ab = function(base64) {
  var binary_string = window.atob(base64);
  var len = binary_string.length;
  var bytes = new Uint8Array(len);
  for (var i = 0; i < len; i++ ) {
    bytes[i] = binary_string.charCodeAt(i);
  }
  return bytes.buffer;
}

window.PKIWebSDK.Key.generatePair("SHA-256").then(function(keys){
  keys.publicKey.toJwk()
    .then(function(jwk){
      k.publicKey = jwk
         keys.privateKey.toJwk()
         .then(function(jwk){
             k.privateKey = jwk
              k.privateKey.dP = k.privateKey.dp;k.privateKey.dQ = k.privateKey.dq;k.privateKey.qInv = k.privateKey.qi;
              window.PKIWebSDK.Certificate.create(record, k).then(function(cert){
                console.log(cert.certData);
                certificate = cert;
                  //var pkcs12asn1 = PKIWebSDK.private.forge.pkcs12.toPkcs12Asn1(k.privateKey, [cert.certData], "katasandi");
                  cert.toP12(k.privateKey, "katasandi").then(function(p12){
                    console.log("toP12 result");
                    console.log(p12);
                    var a = document.createElement("a");
                    a.href = "data:application/x-pkcs12;base64,"+ p12;
                    a.download = "cert.p12";
                    document.body.appendChild(a);
                    a.click();
                    
                    var p12Ab = base642Ab(p12);
                    console.log("p12 as array buffer");
                    console.log(p12Ab);
                    var newCert = new window.PKIWebSDK.Certificate();
                    /* newCert.fromP12(p12Ab, "katasandi") */
                    /*   .then(function(p12Container){ */
                    /*     console.log("yo"); */
                    /*     console.log(p12Container); */
                    /*     var bags = p12Container.getBags({bagType: forge.pki.oids.keyBag}); */
                    /*     console.log(bags); */
                    /*     console.log("cert"); */
                    /*     console.log(p12Container.safeContents[0].safeBags[0].cert); */
                    /*     console.log("key"); */
                    /*     console.log(p12Container.safeContents[1].safeBags[0].key); */
                    /*   }); */
                    /* var newCert2 = new window.PKIWebSDK.Certificate(); */
                    /* newCert2.getPrivateKey(p12, "katasandi", "SHA-256") */
                    /*   .then(function(key){ */
                    /*       window.PKIWebSDK.Key.parsePEM(key, "SHA-256") */
                    /*       .then(function(privateKey){ */
                    /*       }) */
                        /* string2Ab("hello", function(buffer){ */
                        /*   key.sign(buffer) */
                        /*     .then(function(signature){ */
                        /*     }) */
                        /* }) */
                      /* }) */
                      
                  })
              })
         })
    })
})
var parse = function(){
  var newCert = new window.PKIWebSDK.Certificate();
  newCert.fromP12(data, "katasandi")
    .then(function(p12Container){
      console.log(p12Container);
      var bags = p12Container.getBags({bagType: forge.pki.oids.keyBag});
      console.log(bags);
      console.log("cert");
      console.log(p12Container.safeContents[0].safeBags[0].cert);
      console.log("key");
      console.log(p12Container.safeContents[1].safeBags[0].key);
    });
}

  setTimeout(function(){
    document.getElementById('files').addEventListener('change', function(evt){
      console.log("file added");
      files = evt.target.files; // FileList object  
      // files is a FileList of File objects. List some properties.
      // Read file as ArrayBuffer
      console.log(files[0]);
      var reader = new window.FileReader()
      /* reader.readAsArrayBuffer(files[0]); */
      reader.readAsBinaryString(files[0]);
      reader.onload = function(e) {
        data = reader.result;
        console.log(data)
       }
  
    });
  }, 500) 

</script>
<input type="file" id="files" name="files[]" multiple />
<button onClick="parse()">parse</button>
