<html>
    <head>
        <script src="../../build/bundle.js"></script>
    </head>
    <body>
            Parse P12 to Cert <div id="parse-p12"></div><br>
            <br>
            PDF file to sign <input id="pdf-file" type="file"></input>
            <br>
            Get the signature of <input id="pdf-file-get-signature" type="file"></input><br>
            Signature <br>
            <textarea cols="50" rows="10" id="signature"></textarea>
            <hr>
            Parse P12 in purpose of signing a document <div id="parse-p12-to-sign"></div><br>
            <br>
            <br>
    </body>
  <script>
    var certificate;
    var privateKey;
    var pdfData;
    var pdf;
  
    // Render an element that handle P12 file
    window.PKIWebSDK.UI.getP12("parse-p12", function(promise){
      promise.then(function(result){
        console.log(result);
        certificate = result.certificate;
        window.PKIWebSDK.Key.parsePEM(result.privateKey, "SHA-256")
          .then(function(key){
            privateKey = key;
            var msg = "P12 was successfully parsed. Select a pdf file to be signed. Subject of the current certificate :\n";
            certificate.getSubject()
              .then(function(subject){
                msg += JSON.stringify(subject);
                alert(msg);
              })
          })
          .catch(function(err){
            alert(err.message);
          })
      })
      .catch(function(err){
        alert(err.message);
      })
    })
    
    // Event listener to #pdf-file element. Sign the pdf file when added.
    document.getElementById('pdf-file').addEventListener('change', function(evt){
      var files = evt.target.files; // FileList object  
      // Read file as ArrayBuffer
      var reader = new window.FileReader()
      reader.readAsArrayBuffer(files[files.length-1]);
      reader.onload = function(e) {
        pdfData = reader.result;
        pdf = new window.PKIWebSDK.PDF(new Uint8Array(pdfData));
        var info = {
          name : "Someone",
          reason : "Test",
          location : "Greater Jakarta Area",
          contactInfo : "email@domain"
        }
        pdf.sign(certificate, privateKey, info)
          .then(function(doc){
            console.log(doc);
            window.PKIWebSDK.Utils.toFile(doc, "signed-data", "application/pdf");
          })
          .catch(function(err){
            alert(err.message);
          })
       }
    });
    
    // Event listener of #pdf-file-get-signature element. Obtains signature information.
    document.getElementById('pdf-file-get-signature').addEventListener('change', function(evt){
      var files = evt.target.files; // FileList object  
      // Read file as ArrayBuffer
      var reader = new window.FileReader()
      reader.readAsArrayBuffer(files[files.length-1]);
      reader.onload = function(e) {
        pdfData = reader.result;
        pdf = new window.PKIWebSDK.PDF(new Uint8Array(pdfData));
        pdf.getSignatures()
        .then(function(result){
            console.log(result);
            alert("Successfully obtained the signature.");
            document.getElementById("signature").value = result[0].signedData.data.rawCapture.signature;
          })
          .catch(function(err){
            alert(err.message);
          })
       }
    });
    
    // Render an element that handle P12 file in purpose of signing a document
    window.PKIWebSDK.UI.signPDF("parse-p12-to-sign", function(promise){
      promise.then(function(doc){
        window.PKIWebSDK.Utils.toFile(doc, "signed-data", "application/pdf");
      })
      .catch(function(err){
        alert(err.message);
      })
    })
  
  </script>
</html>
